/*
 * CodeCogs equation editor plugin for TinyMCE version 6.3
 * 
 * Requirements: tinymce^6.3
 * 
 * Simply load this file into your webpage after you have loaded the TinyMCE script
 * and initialise your TinyMCE instance at any point after that, making sure to add 'eqneditor' in
 * your list of plugins.
 * OK
 */

tinymce.PluginManager.add("eqneditor", function(editor, url) {
    var host = 'editor.codecogs.com';
    var http = ('https:' == document.location.protocol ? 'https://' : 'http://');

    // Load necessary javascript for editor from CodeCogs
    var sl = new tinymce.dom.ScriptLoader();
    sl.add(http + host + '/eqneditor.api.min.js');
    var loaded = sl.loadQueue();

    // Load custom CSS
    tinymce.DOM.loadCSS(http + host + '/eqneditor.css');

    editor.ui.registry.addIcon('logo', `<svg width="102" height="34">
    <g>
        <image  x="0" y="0" xlink:href="data:image/png;base64,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" preserveAspectRatio="none" width="102" height="34"/>
    </g>
    </svg>`)

    editor.ui.registry.addIcon('menu', `<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='11.473512pt' height='12.266481pt' viewBox='-.239051 -.242965 11.473512 12.266481'>
    <defs>
    <path id='g0-120' d='M3.993026-3.180075C3.642341-3.092403 3.626401-2.781569 3.626401-2.749689C3.626401-2.574346 3.761893-2.454795 3.937235-2.454795S4.383562-2.590286 4.383562-2.933001C4.383562-3.387298 3.881445-3.514819 3.58655-3.514819C3.211955-3.514819 2.909091-3.251806 2.725778-2.940971C2.550436-3.363387 2.13599-3.514819 1.809215-3.514819C.940473-3.514819 .454296-2.518555 .454296-2.295392C.454296-2.223661 .510087-2.191781 .573848-2.191781C.669489-2.191781 .68543-2.231631 .70934-2.327273C.892653-2.909091 1.370859-3.291656 1.785305-3.291656C2.096139-3.291656 2.247572-3.068493 2.247572-2.781569C2.247572-2.622167 2.15193-2.255542 2.088169-2.000498C2.032379-1.769365 1.857036-1.060025 1.817186-.908593C1.705604-.478207 1.41868-.143462 1.060025-.143462C1.028144-.143462 .820922-.143462 .653549-.255044C1.020174-.342715 1.020174-.67746 1.020174-.68543C1.020174-.868742 .876712-.980324 .70137-.980324C.486177-.980324 .255044-.797011 .255044-.494147C.255044-.127522 .645579 .079701 1.052055 .079701C1.474471 .079701 1.769365-.239103 1.912827-.494147C2.088169-.103611 2.454795 .079701 2.83736 .079701C3.706102 .079701 4.184309-.916563 4.184309-1.139726C4.184309-1.219427 4.120548-1.243337 4.064757-1.243337C3.969116-1.243337 3.953176-1.187547 3.929265-1.107846C3.769863-.573848 3.315567-.143462 2.8533-.143462C2.590286-.143462 2.399004-.318804 2.399004-.653549C2.399004-.812951 2.446824-.996264 2.558406-1.44259C2.614197-1.681694 2.789539-2.383064 2.82939-2.534496C2.940971-2.948941 3.219925-3.291656 3.57858-3.291656C3.618431-3.291656 3.825654-3.291656 3.993026-3.180075Z'/>
    <path id='g1-102' d='M5.332005-4.805978C5.571108-4.805978 5.66675-4.805978 5.66675-5.033126C5.66675-5.152677 5.571108-5.152677 5.355915-5.152677H4.387547C4.614695-6.38406 4.782067-7.232877 4.877709-7.615442C4.94944-7.902366 5.200498-8.177335 5.511333-8.177335C5.762391-8.177335 6.01345-8.069738 6.133001-7.962142C5.66675-7.914321 5.523288-7.567621 5.523288-7.364384C5.523288-7.12528 5.702615-6.981818 5.929763-6.981818C6.168867-6.981818 6.527522-7.185056 6.527522-7.639352C6.527522-8.141469 6.025405-8.416438 5.499377-8.416438C4.985305-8.416438 4.483188-8.033873 4.244085-7.567621C4.028892-7.149191 3.90934-6.718804 3.634371-5.152677H2.833375C2.606227-5.152677 2.486675-5.152677 2.486675-4.937484C2.486675-4.805978 2.558406-4.805978 2.797509-4.805978H3.56264C3.347447-3.694147 2.857285-.992279 2.582316 .286924C2.379078 1.327024 2.199751 2.199751 1.601993 2.199751C1.566127 2.199751 1.219427 2.199751 1.004234 1.972603C1.613948 1.924782 1.613948 1.398755 1.613948 1.3868C1.613948 1.147696 1.43462 1.004234 1.207472 1.004234C.968369 1.004234 .609714 1.207472 .609714 1.661768C.609714 2.175841 1.135741 2.438854 1.601993 2.438854C2.82142 2.438854 3.323537 .251059 3.455044-.3467C3.670237-1.267248 4.25604-4.447323 4.315816-4.805978H5.332005Z'/>
    </defs>
    <g id='page1' transform='matrix(1.13 0 0 1.13 -63.986043 -65.03376)'>
    <use x='56.413267' y='65.753425' xlink:href='#g1-102'/>
    <use x='62.183256' y='67.546688' xlink:href='#g0-120'/>
    </g>
    </svg>`)

    function showDialog(inp="") {
        var http = ('https:' == document.location.protocol ? 'https://' : 'http://');

        win = editor.windowManager.open({
            title: 'Equation Editor',
            size: 'medium',
            body: {
                type: 'panel',
                items: [{
                    type: 'htmlpanel',
                    html: '<div id="equation-editor">' + '<div id="history"></div>' + '<div id="toolbar"></div>' + '<div id="latexInput" autocorrect="off"></div>' + '<div id="equation-output">' + '<img id="output"></div></div>'
                }]
            },
            buttons: [{
                type: 'cancel',
                name: 'closeButton',
                text: 'Cancel'
            }, {
                type: 'submit',
                name: 'submitButton',
                text: 'Ok',
                buttonType: 'primary'
            }, {
                type: 'custom',
                name: 'logo',
                text: '',
                icon: 'logo',
                align: 'start'
            }],
            onSubmit: function(w) {
                tinymce.activeEditor.execCommand('mceInsertContent', false, output.exportAs('html'));
                textarea.pushToHistory();
                w.close();
            },
            onCancel: function(w) {
                w.close();
            },
            onAction: function(w, dets) {
                if (dets.name == 'logo') {
                    window.open(http + 'editor.codecogs.com', '_blank').focus();
                }
            }
        })

        // Ensure EqnEditor js is loaded before continuing
        loaded.then( () => {
                output = new EqEditor.Output("output");
                textarea = EqEditor.TextArea.link("latexInput").addOutput(output).addHistoryMenu(new EqEditor.History("history"));
                EqEditor.Toolbar.link("toolbar").addTextArea(textarea);

                var nodes = document.getElementById('history').childNodes;
                for (var i = 0; i < nodes.length; i++) {
                    nodes[i].style.padding = 'revert';
                }

                textarea.clear();
                textarea.insert(inp.replace(/&space;/g, ' '), inp.length);
            }
        );
    }

    editor.ui.registry.addButton('eqneditor', {
        title: 'Equation',
        icon: 'menu',
        tooltip: 'Insert Equation',
        onAction: () => {
            showDialog();
        }
        // stateSelector: 'img[src*="latex"]'
    });

    editor.on('dblclick', function(e) {
        if (e.target.nodeName.toLowerCase() == "img") {
            var sName = e.target.src.match(/(gif|svg)\.image\?(.*)/);
            if (sName != null)
                showDialog(sName[2]);
        }
    });

    return {
        getMetadata: () => ({
            name: 'EqnEditor',
            url: 'https://editor.codecogs.com/docs/3-Tiny_MCE_v6.php'
        })
    };
});
